<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- import tweakpane for creating & managing the UI elements -->
    <script src="js/external/tweakpane/tweakpane-3.1.1.min.js"></script>
    <script src="js/external/tweakpane-plugin-essentials/tweakpane-plugin-essentials-0.1.5.min.js"></script>
</head>
<body>
    <script type="module">
        import init, { main } from "./pkg/parametric_l_systems.js";

        const createUi = (event) => {
            const eventTarget = event.currentTarget;

            // todo: build UI and dispatch events
            const pane = new Tweakpane.Pane({
                title: 'Parametric L-Systems',
                expanded: true,
            });
            pane.registerPlugin(TweakpaneEssentialsPlugin);

            const settings = {
                iteration: 0,
            };

            const iterationsSlider = pane.addInput(settings, 'iteration', {
                label: 'Iteration',
                min: 0, max: settings.maxIteration, step: 1,
            });
            iterationsSlider.on('change', e => {
                eventTarget.dispatchEvent(new CustomEvent(
                    'ui::lsystem::iteration',
                    { detail: { lSystem: { iteration: e.value } } }
                ));
            });

            console.debug('created UI');
        }

        const mutationObserver = new MutationObserver(mutations => {
            mutations.forEach(m => {
                m.addedNodes.forEach(n => {
                    if (n instanceof HTMLCanvasElement) {
                        n.addEventListener('app::initialized', createUi);
                    }
                });
            });
        });
        mutationObserver.observe(document.body, { childList: true });

        async function run() {
            await init();
            main(
                {
                    axiom: 'A(1,10)',
                    productions: [
                        'A(l,w) -> F(l,w)[&(a0)B(l*r2,w*wr)]/(d)A(l*r1,w*wr)',
                        'B(l,w) -> F(l,w)[+(-a1)$C(l*r2,w*wr)]C(l*r1,w*wr)',
                        'C(l,w) -> F(l,w)[+(a1)$B(l*r2,w*wr)]B(l*r1,w*wr)'
                    ],
                    parameters: {r1: 7.0, r2: 7.1, a0: 7.2, a1: 7.3, d: 7.4, wr: 7.5},
                    alphabet: ['A(l,w)', 'B(l,w)', 'C(l,w)', 'F(l,w)', '[', ']', '+(a)', '&(a)', '/(d)', '$'],
                }
            );
        }
        run();
    </script>
</body>
</html>
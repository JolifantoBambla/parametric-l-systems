<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parametric L-Systems</title>
    <!-- import materialize -->
    <link rel="stylesheet" href="css/materialize/css/materialize.min.css"/>

    <!-- import Google icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- import tweakpane for the viewer's UI elements -->
    <script src="js/external/tweakpane/tweakpane-3.1.1.min.js"></script>
    <script src="js/external/tweakpane-plugin-essentials/tweakpane-plugin-essentials-0.1.5.min.js"></script>
</head>
<body>
    <header>
        <div class="row">
            <div class="col xl12">
                <h1>Parametric L-System Explorer</h1>
            </div>
        </div>
    </header>
    <div class="divider"></div>

    <main>
        <div class="row">
            <div class="col xl12">
                <div class="col xl4">
                    <div class="row">
                        <h4>Scene Editor</h4>
                        <div class="col xl12">
                            <div id="editor" style="width: 100%; height: 50vh; border: 1px solid grey"> </div>
                            <div class = "file-field input-field waves-effect waves-light btn-small" style="width: 24.6%;" type="submit">
                                <i class="material-icons left">cloud_upload</i>Upload Scene
                                <input type="file" accept="application/json" id="scene-upload-button">
                            </div>
                            <button class="waves-effect waves-light btn-small" style="width: 24.6%;" type="submit" id="scene-download-button"><i class="material-icons left">save</i>Save Scene</button>
                            <button class="waves-effect waves-light btn-small" style="width: 24.5%;" type="submit" id="l-system-test-button"><i class="material-icons left">play_circle_outline</i>Test</button>
                            <button class="waves-effect waves-light btn-small" style="width: 24.6%;" type="submit" id="l-system-render-button"><i class="material-icons left">play_circle_filled</i>Render</button>
                        </div>
                    </div>
                    <div class="divider"></div>
                    <div class="row">
                        <div class="col xl12">
                            <h5>Iterations</h5>
                            <textarea id="l-system-iterations" style="height: 14vh;" readonly="readonly"></textarea>
                        </div>
                    </div>
                </div>

                <div class="col xl8" id="scene-view-container" style="position: relative; height: 80vh;">
                    <canvas style="width: 100%; height: 100%; background-color:rgb(0, 0, 0);position: absolute" id="scene-view"></canvas>
                    <div id="ui" style="position: absolute; right: 0; z-index: 1;"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="page-footer">
        <div class="container">
            <div class="row">
                <div class="col l6 xl12">
                    <h5 class="white-text">Footer Content</h5>
                    <p class="grey-text text-lighten-4">You can use rows and columns here to organize your footer content.</p>
                </div>
            </div>
        </div>
        <div class="footer-copyright">
            <div class="container">
                Â© 2023 Copyright Text
                <a class="grey-text text-lighten-4 right" href="#!">More Links</a>
            </div>
        </div>
    </footer>

    <script type="text/javascript" src="js/external/materialize/js/materialize.min.js"></script>
    <script src="ace-builds-1.5.0/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script>
        // https://stackoverflow.com/questions/19721439/download-json-object-as-a-file-from-browser
        function downloadObjectAsJson(obj, fileName, indent = null){
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute(
                'href', `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(obj, null, indent))}`
            );
            downloadAnchorNode.setAttribute('download', `${fileName}.json`);
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>

    <script type="module">
        import init, { main } from "./pkg/parametric_l_systems.js";
        import {LSystemIterator} from './js/l-system/l-system.js';
        import * as defaultScene from './scenes/tree-prusinkiewicz.json' assert {type: 'json'};

        let activeScene = null;
        let activeSceneLocked = true;

        const editor = ace.edit('editor');
        editor.setTheme('ace/theme/github');
        editor.session.setMode('ace/mode/json');
        editor.setValue(JSON.stringify({...defaultScene.default}, null, 2));
        const parseCurrentSceneSource = () => {
            // todo: parse DSL into scene JSON / object
            return JSON.parse(editor.getValue());
        }
        const parseSceneJsonToDSL = sceneJson => {
            // todo: parse scene into L-System DSL
            return sceneJson;
        }

        const lSystemIterations = document.getElementById('l-system-iterations');

        const testSystems = (scene) => {
            return Object.keys(scene.systems).map(systemName => {
                const s = scene.systems[systemName];
                const definition = s.definition;
                const results = [
                    `System "${systemName}":`,
                ];
                for (const instanceName in s.instances) {
                    const instance = s.instances[instanceName];
                    results.push(`  ${instanceName}:`);
                    const iterator = LSystemIterator.createLSystemIterator({
                        ...definition,
                        parameters: {
                            ...definition.parameters,
                            ...instance.parameters,
                        }
                    });
                    results.push(`    0: ${iterator.current()}`);
                    const iterations = instance.unlimitedTestIterations ? instance.iterations : Math.min(3, instance.iterations);
                    for (let i = 0; i < iterations; ++i) {
                        results.push(`    ${i + 1}: ${iterator.next()}`);
                    }
                    results.push('\n');
                }
                return results.join('\n');
            });
        };
        const testAndPrintSystems = (scene) => {
            lSystemIterations.value = testSystems(scene).join('\n\n');
        }

        const sceneToViewerInputs = (scene) => {
            const systems = {};
            for (const systemName in scene.systems) {
                const system = scene.systems[systemName]
                systems[systemName] = {
                };
                for (const instanceName in system.instances) {
                    systems[systemName][instanceName] = {
                        ...system.definition,
                        parameters: {
                            ...system.definition.parameters,
                            ...system.instances[instanceName].parameters
                        }
                    }
                }
            }
            if (scene.resources) {
                for (const resource of Object.values(scene.resources)) {
                    if (resource.type === "obj") {
                        if (resource.path) {
                            // todo: fetch obj (i.e., refactor into callback foo)
                        }
                    }
                }
            }
            return [scene, systems];
        }

        const sceneUploadButton = document.getElementById('scene-upload-button');
        sceneUploadButton.addEventListener('change', e => {
            const reader = new FileReader();
            reader.onload = event => {
                const scene = parseSceneJsonToDSL(JSON.parse(String(event.target.result)));
                // todo: parse scene into L-System DSL
                editor.setValue(String(event.target.result));
            }
            reader.readAsText(e.target.files[0]);
        });
        const sceneDownloadButton = document.getElementById('scene-download-button');
        sceneDownloadButton.addEventListener('click', _ => {
            // todo: parse DSL to scene JSON / object
            downloadObjectAsJson(parseCurrentSceneSource(), 'scene', 2);
        });
        const lSystemTestButton = document.getElementById('l-system-test-button');
        lSystemTestButton.addEventListener('click', () => {
            const scene = parseCurrentSceneSource();
            if (scene.systems) {
                testAndPrintSystems(scene);
            }
        })
        const lSystemRenderButton = document.getElementById('l-system-render-button');
        lSystemRenderButton.addEventListener('click', _ => {
            const scene = parseCurrentSceneSource();
            if (!activeSceneLocked && scene.systems) {
                activeSceneLocked = true;
                activeScene = scene;
                try {
                    testAndPrintSystems(scene);
                    const [sceneDescriptor, lSystemDefinitions] = sceneToViewerInputs(scene);
                    sceneCanvas.dispatchEvent(new CustomEvent(
                        'ui::scene::new',
                        {detail: {scene: {new: {sceneDescriptor, lSystemDefinitions}}}}
                    ));
                    buildUi();
                } catch (err) {
                    console.error(err);
                }
                activeSceneLocked = false;
            }
        });

        const uiElement = document.getElementById('ui');
        const pane = new Tweakpane.Pane({
            title: 'Viewer',
            expanded: true,
            container: uiElement,
        });
        pane.registerPlugin(TweakpaneEssentialsPlugin);
        let activeSceneFolder = null;
        const buildUi = () => {
            if (activeScene) {
                if (activeSceneFolder) {
                    activeSceneFolder.hidden = true;
                    // todo: can I also destroy this?
                }
                activeSceneFolder = pane.addFolder({
                    title: 'Scene',
                    expanded: true,
                });

                // todo: fps graph

                const backgroundColor = {r: 0, g: 0, b: 0};
                if (activeScene.scene.camera.backgroundColor) {
                    backgroundColor.r = activeScene.scene.camera.backgroundColor[0];
                    backgroundColor.r = activeScene.scene.camera.backgroundColor[1];
                    backgroundColor.r = activeScene.scene.camera.backgroundColor[2];
                }
                const sceneSettings = {
                    backgroundColor,
                }

                const backgroundColorPicker = activeSceneFolder.addInput(sceneSettings, 'backgroundColor', {
                    label: 'Background color',
                    picker: 'inline',
                    expanded: false,
                    color: {type: 'float'},
                });
                backgroundColorPicker.on('change', e => {
                    sceneCanvas.dispatchEvent(new CustomEvent(
                        'ui::scene::background-color',
                        {detail: {scene: {backgroundColor: [e.value.r, e.value.g, e.value.b]}}}
                    ));
                });

                const lSystemObjectsFolder = activeSceneFolder.addFolder({
                    title: 'L-System Objects',
                    expanded: true,
                });
                for (const objectName in activeScene.scene.objects) {
                    const obj = activeScene.scene.objects[objectName];
                    if (obj.type === 'lSystem') {
                        const objectFolder = lSystemObjectsFolder.addFolder({
                            title: objectName,
                            expanded: true,
                        });

                        const instance = activeScene.systems[obj.system].instances[obj.instance];
                        const settings = {
                            iteration: obj.iteration || instance.iterations,
                        };

                        const iterationsSlider = objectFolder.addInput(settings, 'iteration', {
                            label: 'Iteration',
                            min: 1, max: instance.iterations + 1, step: 1,
                        });
                        iterationsSlider.on('change', e => {
                            sceneCanvas.dispatchEvent(new CustomEvent(
                                'ui::lsystem::iteration',
                                {detail: {lSystem: {iteration: {objectName, iteration: e.value - 1}}}}
                            ));
                        });
                    }
                }
            }

            console.debug('created UI');
        }

        const sceneViewContainer = document.getElementById('scene-view-container');
        const sceneCanvas = document.getElementById('scene-view');
        sceneCanvas.width = sceneViewContainer.clientWidth;
        sceneCanvas.height = sceneViewContainer.clientHeight;
        sceneCanvas.addEventListener('app::initialized', _ => {
            buildUi();
            activeSceneLocked = false;
        });

        async function run(canvasId, scene, systems) {
            await init();
            main(canvasId, scene, systems);
        }

        activeScene = parseCurrentSceneSource();
        testAndPrintSystems(activeScene);
        run(sceneCanvas.id, ...sceneToViewerInputs(activeScene));
    </script>
</body>
</html>
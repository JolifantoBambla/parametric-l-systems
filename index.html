<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- import tweakpane for creating & managing the UI elements -->
    <script src="js/external/tweakpane/tweakpane-3.1.1.min.js"></script>
    <script src="js/external/tweakpane-plugin-essentials/tweakpane-plugin-essentials-0.1.5.min.js"></script>
</head>
<body>
    <script type="module">
        import init, { main } from "./pkg/parametric_l_systems.js";
        import {LSystemParser} from "./js/l-system/module.js";

        const createUi = (event) => {
            const eventTarget = event.currentTarget;

            // todo: build UI and dispatch events
            const pane = new Tweakpane.Pane({
                title: 'Parametric L-Systems',
                expanded: true,
            });
            pane.registerPlugin(TweakpaneEssentialsPlugin);

            const settings = {
                iteration: 0,
            };

            const iterationsSlider = pane.addInput(settings, 'iteration', {
                label: 'Iteration',
                min: 0, max: 5, step: 1,
            });
            iterationsSlider.on('change', e => {
                eventTarget.dispatchEvent(new CustomEvent(
                    'ui::lsystem::iteration',
                    { detail: { lSystem: { iteration: e.value } } }
                ));
            });

            console.debug('created UI');
        }

        const mutationObserver = new MutationObserver(mutations => {
            mutations.forEach(m => {
                m.addedNodes.forEach(n => {
                    if (n instanceof HTMLCanvasElement) {
                        n.addEventListener('app::initialized', createUi);
                    }
                });
            });
        });
        mutationObserver.observe(document.body, { childList: true });

        const lightSources = [
            {
                light: {
                    color: [0.0, 0.0, 0.5],
                    intensity: 1.0,
                },
                source: {
                    point: {
                        position: [1.0, 0.0, 0.0]
                    }
                }
            },
            {
                light: {
                    color: [0.5, 0.0, 0.0],
                    intensity: 1.0,
                },
                source: {
                    point: {
                        position: [-1.0, 0.0, 0.0]
                    }
                }
            }
        ];


        const otherTreeModel = {
            // todo: axiom may use system parameters
            axiom: 'A(100,30)',
            productions: [
                'A(l,w): l >= min -> F(l,w)[+(a1)/(g1)A(l*r1,w*Math.pow(q,e))][+(a2)/(g2)A(l*r2,w*Math.pow(1.0-q,e))]'
            ],
            parameters: {
                a1: 30.0,
                a2: -30.0,
                r1: 0.8,
                r2: 0.8,
                g1: 137.0,
                g2: 137.0,
                q: 0.5,
                e: 0.5,
                min: 0.0,
                w0: 30.0
            },
            alphabet: ['A(l,w)', 'F(l,w)', '[', ']', '+(a)', '/(d)'],
        }
        console.log(new LSystemParser({}).parseLSystem(otherTreeModel));

        // https://math.stackexchange.com/questions/123642/representing-a-3d-hilbert-curve-as-an-l-system
        // + Yaw(90)  +
        // - Yaw(-90)
        // ^ Pitch(90)  &
        // & Pitch(-90)
        // > Roll(90)  /
        // < Roll(-90)
        // ^ < X F ^ < X F X - F ^ > > X F X & F + > > X F X - F > X - >;
        const hilbertCurve3d = {
            axiom: 'X',
            productions: [
                'X -> &(90)/(-90)XF(0.5,0.25)&(90)/(-90)XF(0.5,0.25)X+(-90)F(0.5,0.25)&(90)/(90)/(90)XF(0.5,0.25)X&(-90)F(0.5,0.25)+(90)/(90)/(90)XF(0.5,0.25)X+(-90)F(0.5,0.25)/(90)X+(-90)/(90)'
            ],
            parameters: {},
            alphabet: ['X', 'F(x,y)', '+(x)', '&(x)', '/(x)']
        };

        const treeModel = {
            axiom: 'A(1,10)',
            productions: [
                'A(l,w) -> F(l,w)[&(a0)B(l*r2,w*wr)]/(d)A(l*r1,w*wr)',
                'B(l,w) -> F(l,w)[+(-a1)$C(l*r2,w*wr)]C(l*r1,w*wr)',
                'C(l,w) -> F(l,w)[+(a1)$B(l*r2,w*wr)]B(l*r1,w*wr)'
            ],
            parameters: {r1: 7.0, r2: 7.1, a0: 7.2, a1: 7.3, d: 7.4, wr: 7.5},
            alphabet: ['A(l,w)', 'B(l,w)', 'C(l,w)', 'F(l,w)', '[', ']', '+(a)', '&(a)', '/(d)', '$'],
        }

        async function run() {
            await init();
            main(lightSources, otherTreeModel);
        }
        run();
    </script>
</body>
</html>
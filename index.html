<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parametric L-Systems</title>
    <!-- import tweakpane for creating & managing the UI elements -->
    <script src="js/external/tweakpane/tweakpane-3.1.1.min.js"></script>
    <script src="js/external/tweakpane-plugin-essentials/tweakpane-plugin-essentials-0.1.5.min.js"></script>
</head>
<body>
    <script type="module">
        import init, { main } from "./pkg/parametric_l_systems.js";
        import { addJsonFilePicker } from "./js/util/tweakpane-file-picker.js";

        const createUi = (event) => {
            const eventTarget = event.currentTarget;

            const pane = new Tweakpane.Pane({
                title: 'Parametric L-Systems',
                expanded: true,
            });
            pane.registerPlugin(TweakpaneEssentialsPlugin);

            const settings = {
                iteration: 0,
            };

            const iterationsSlider = pane.addInput(settings, 'iteration', {
                label: 'Iteration',
                min: 0, max: 5, step: 1,
            });
            iterationsSlider.on('change', e => {
                eventTarget.dispatchEvent(new CustomEvent(
                    'ui::lsystem::iteration',
                    { detail: { lSystem: { iteration: e.value } } }
                ));
            });

            console.debug('created UI');
        }

        const mutationObserver = new MutationObserver(mutations => {
            mutations.forEach(m => {
                m.addedNodes.forEach(n => {
                    if (n instanceof HTMLCanvasElement) {
                        n.addEventListener('app::initialized', createUi);
                    }
                });
            });
        });
        mutationObserver.observe(document.body, { childList: true });

        const lightSources = [
            {
                light: {
                    color: [0.0, 0.0, 1.0],
                    intensity: 1.0,
                },
                source: {
                    point: {
                        position: [1.0, 0.0, 0.0]
                    }
                }
            },
            {
                light: {
                    color: [1.0, 0.0, 0.0],
                    intensity: 1.0,
                },
                source: {
                    point: {
                        position: [-1.0, 0.0, 0.0]
                    }
                }
            }
        ];

        // Prusinkiewicz, Przemyslaw et al. “L-systems: from the Theory to Visual Models of Plants.” (2001).
        // (adapted from Table 1)
        const treeModelConfigs = [
            {r1: 0.75, r2: 0.77, a1: 35.0, a2: -35.0, g1:   0.0, g2:   0.0, w0: 30.0, q: 0.5,  e: 0.4,  min:  0.0},
            {r1: 0.65, r2: 0.71, a1: 27.0, a2: -68.0, g1:   0.0, g2:   0.0, w0: 20.0, q: 0.53, e: 0.5,  min:  1.7},
            {r1: 0.5,  r2: 0.85, a1: 25.0, a2: -15.0, g1: 180.0, g2:   0.0, w0: 20.0, q: 0.45, e: 0.5,  min:  0.5},
            {r1: 0.6,  r2: 0.85, a1: 25.0, a2: -15.0, g1: 180.0, g2: 180.0, w0: 20.0, q: 0.45, e: 0.5,  min:  0.0},
            {r1: 0.58, r2: 0.83, a1: 30.0, a2:  15.0, g1:   0.0, g2: 180.0, w0: 20.0, q: 0.4,  e: 0.5,  min:  1.0},
            {r1: 0.92, r2: 0.37, a1:  0.0, a2:  60.0, g1: 180.0, g2:   0.0, w0:  2.0, q: 0.5,  e: 0.0,  min:  0.5},
            {r1: 0.8,  r2: 0.8,  a1: 30.0, a2: -30.0, g1: 137.0, g2: 137.0, w0: 30.0, q: 0.5,  e: 0.5,  min:  0.0},
            {r1: 0.95, r2: 0.75, a1:  5.0, a2: -30.0, g1: -90.0, g2:  90.0, w0: 40.0, q: 0.6,  e: 0.45, min: 25.0},
            {r1: 0.55, r2: 0.95, a1: -5.0, a2:  30.0, g1: 137.0, g2: 137.0, w0:  5.0, q: 0.4,  e: 0.0,  min:  5.0},
        ];

        // Prusinkiewicz, Przemyslaw et al. “L-systems: from the Theory to Visual Models of Plants.” (2001).
        // (adapted from Listing 11)
        const otherTreeModel = {
            axiom: 'A(100,w0)',
            productions: [
                'A(l,w): l >= min -> F(l,w)[+(a1)/(g1)A(l*r1,w*Math.pow(q,e))][+(a2)/(g2)A(l*r2,w*Math.pow(1.0-q,e))]'
            ],
            parameters: treeModelConfigs[6],
            alphabet: ['A(l,w)', 'F(l,w)', '[', ']', '+(a)', '/(d)'],
        }

        const testPreSucParams = {
            axiom: 'A(20,w0)B(10,w0)F(20,w0)F(20,w0)F(10,w0)F(20,w0)~("hello world2")',
            productions: [
                'F(l,w) -> ~("hello world")F(l*2.0,w*2.0)',
                'F(l1,w1) > F(l2,w2): l1 > l2 || w1 > w2 -> F(l1*2.0,w1*2.0)~("hello world")',
                'A(l1,w1)B(l2,w2) < F(l3,w3): l1 > l2 || w1 > w2 -> F(l3*2.0,w3*2.0)~("hello world")',
            ],
            parameters: treeModelConfigs[6],
            alphabet: ['A(l,w)', 'B(l,w)', 'F(l,w)', '[', ']', '+(a)', '/(d)', '~(x)'],
        }

        // https://math.stackexchange.com/questions/123642/representing-a-3d-hilbert-curve-as-an-l-system
        // + Yaw(90)  +
        // - Yaw(-90)
        // ^ Pitch(90)  &
        // & Pitch(-90)
        // > Roll(90)  /
        // < Roll(-90)
        // ^ < X F ^ < X F X - F ^ > > X F X & F + > > X F X - F > X - >;
        const hilbertCurve3d = {
            axiom: 'X',
            productions: [
                'X -> &(90)/(-90)XF(0.5,0.25)&(90)/(-90)XF(0.5,0.25)X+(-90)F(0.5,0.25)&(90)/(90)/(90)XF(0.5,0.25)X&(-90)F(0.5,0.25)+(90)/(90)/(90)XF(0.5,0.25)X+(-90)F(0.5,0.25)/(90)X+(-90)/(90)'
            ],
            parameters: {},
            alphabet: ['X', 'F(x,y)', '+(x)', '&(x)', '/(x)']
        };

        const treeModel = {
            axiom: 'A(1,10)',
            productions: [
                'A(l,w) -> F(l,w)[&(a0)B(l*r2,w*wr)]/(d)A(l*r1,w*wr)',
                'B(l,w) -> F(l,w)[+(-a1)$C(l*r2,w*wr)]C(l*r1,w*wr)',
                'C(l,w) -> F(l,w)[+(a1)$B(l*r2,w*wr)]B(l*r1,w*wr)'
            ],
            parameters: {r1: 7.0, r2: 7.1, a0: 7.2, a1: 7.3, d: 7.4, wr: 7.5},
            alphabet: ['A(l,w)', 'B(l,w)', 'C(l,w)', 'F(l,w)', '[', ']', '+(a)', '&(a)', '/(d)', '$'],
        }

        async function run() {
            await init();
            main(
                {
                    lightSources,
                    lSystemSettings: {
                        materials: [{color: [1.0, 1.0, 1.0, 1.0]}]
                    }
                },
                otherTreeModel
            );
        }

        run();
    </script>
</body>
</html>
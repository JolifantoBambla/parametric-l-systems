<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parametric L-Systems</title>
    <link rel="stylesheet" href="css/materialize/css/materialize.min.css"/>
    <!-- import tweakpane for creating & managing the UI elements -->
    <script src="js/external/tweakpane/tweakpane-3.1.1.min.js"></script>
    <script src="js/external/tweakpane-plugin-essentials/tweakpane-plugin-essentials-0.1.5.min.js"></script>
</head>
<body>
    <div class="row">
        <div class="col xl12">
            <h1>Parametric L-System Explorer</h1>
        </div>
    </div>

    <div class="divider"></div>

    <div class="row">
        <div class="col xl12">
            <div class="col xl4">
                <!--<h4>L-System</h4>-->
                <ul class="collection">
                    <li class="collection-item"><input type="text"></li>
                    <li class="collection-item"><input type="text"></li>
                    <li class="collection-item"><input type="text"></li>
                    <li class="collection-item"><input type="text"></li>
                </ul>
                <input type="text">
                <textarea></textarea>
                <div class="divider"></div>
            </div>

            <div class="col xl8" id="scene-view-container" style="position: relative; height: 800pt;">
                <!--<h4>Viewer</h4>-->
                <canvas style="width: 100%; height: 100%; background-color:rgb(0, 0, 0);position: absolute" id="scene-view"></canvas>
                <div id="ui" style="position: absolute; right: 0; z-index: 1"></div>
            </div>
        </div>
    </div>

    <footer class="page-footer">
        <div class="container">
            <div class="row">
                <div class="col l6 xl12">
                    <h5 class="white-text">Footer Content</h5>
                    <p class="grey-text text-lighten-4">You can use rows and columns here to organize your footer content.</p>
                </div>
                <div class="col l4 offset-l2 xl12">
                    <h5 class="white-text">Links</h5>
                    <ul>
                        <li><a class="grey-text text-lighten-3" href="#!">Link 1</a></li>
                        <li><a class="grey-text text-lighten-3" href="#!">Link 2</a></li>
                        <li><a class="grey-text text-lighten-3" href="#!">Link 3</a></li>
                        <li><a class="grey-text text-lighten-3" href="#!">Link 4</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="footer-copyright">
            <div class="container">
                Â© 2014 Copyright Text
                <a class="grey-text text-lighten-4 right" href="#!">More Links</a>
            </div>
        </div>
    </footer>

    <script type="text/javascript" src="js/external/materialize/js/materialize.min.js"></script>
    <script type="module">
        import { addJsonFilePicker } from "./js/util/tweakpane-file-picker.js";

        const uiElement = document.getElementById('ui');
        const sceneViewContainer = document.getElementById('scene-view-container');
        const sceneCanvas = document.getElementById('scene-view');

        const pane = new Tweakpane.Pane({
            title: 'Parametric L-Systems',
            expanded: true,
            container: uiElement,
        });
        pane.registerPlugin(TweakpaneEssentialsPlugin);

        const sceneSelectionFolder = pane.addFolder({
            title: 'Scene',
            expanded: true,
        });
        const start = (scene) => {
            sceneSelectionFolder.hidden = true;
            const sceneDetails = {
                lSystem: {
                    alphabet: [],
                    axiom: '',
                    productions: [],
                    parameters: {},
                    maxIterations: 0,
                },
                lightSources: [],
                materials: [],
                ...scene,
            }

            const sceneFolder = pane.addTab({
                pages: [
                    {title: 'L-System'},
                    {title: 'Scene'}
                ]
            });

            const lSystemFolder = sceneFolder.pages[0];

            lSystemFolder.addInput(sceneDetails.lSystem, 'axiom');

            const addExpandableList = (folder, list, title, addNewText, addNewListener = null) => {
                const listFolder = lSystemFolder.addFolder({
                    title,
                    expanded: true,
                });
                for (const i in list) {
                    const inputElement = listFolder.addInput(list, i);
                    if (addNewListener) {
                        addNewListener({
                            key: i,
                            inputElement,
                        })
                    }
                }
                let addNewButton = listFolder.addButton({
                    title: addNewText
                });
                const addNewElement = e => {
                    addNewButton.hidden = true;
                    const i = `${list.length}`;
                    list.push('');
                    const inputElement = listFolder.addInput(list, i);
                    if (addNewListener) {
                        addNewListener({
                            key: i,
                            inputElement,
                        })
                    }
                    addNewButton = listFolder.addButton({
                        title: addNewText
                    });
                    addNewButton.on('click', addNewElement);

                };
                addNewButton.on('click', addNewElement);
            }

            addExpandableList(lSystemFolder, sceneDetails.lSystem.alphabet, 'Alphabet', 'Add new symbol');
            addExpandableList(lSystemFolder, sceneDetails.lSystem.productions, 'Productions', 'Add new production');

            const parametersFolder = lSystemFolder.addFolder({title: 'L-System Parameters', expanded: true});
            const parametersListFolder = parametersFolder.addFolder({title: 'Parameters', expanded: true});
            for (const i in sceneDetails.lSystem.parameters) {
                parametersListFolder.addInput(sceneDetails.lSystem.parameters, i);
            }

            const newParameterInput = {name: 'param', value: '0.0'};
            const newParametersFolder = parametersFolder.addFolder({title: 'New Parameter', expanded: false});
            newParametersFolder.addInput(newParameterInput, 'name');
            newParametersFolder.addInput(newParameterInput, 'value');
            newParametersFolder.addButton({title: 'Add new parameter'})
                .on('click', e => {
                    if (sceneDetails.lSystem.parameters[newParameterInput.name] !== undefined) {
                        alert(`L-System parameter '${newParameterInput.name}' already exists.`);
                    } else {
                        const value = Number(newParameterInput.value);
                        sceneDetails.lSystem.parameters[newParameterInput.name] = isNaN(value) ? newParameterInput.value : value;
                        parametersListFolder.addInput(sceneDetails.lSystem.parameters, newParameterInput.name);
                    }
                });

            // todo: update parameter list when new one is added / name is changed

            if (sceneDetails.lSystem.parameterPresets && sceneDetails.lSystem.parameterPresets.length) {
                const parameterPresetFolder = lSystemFolder.addFolder({title: 'Parameter preset', expanded: true});

                // todo: only add presets they exist
                // todo: update parameters based on preset
                parameterPresetFolder.addBlade({
                    view: 'list',
                    label: 'Choose preset',
                    options: sceneDetails.lSystem.parameterPresets.map((p, i) => {
                        return {
                            text: `Preset ${i}`,
                            value: `${i}`
                        };
                    }),
                    value: '0'
                });
            }

            // todo: add scene page
            // todo: add lights & materials
            // todo: add start button
            // todo: add export button (export sceneDetails)
        }
        const renderExistingScene = addJsonFilePicker(sceneSelectionFolder, 'Load & render scene from file', scene => console.log('todo: render scene', scene));
        const sceneFileUploadButton = addJsonFilePicker(sceneSelectionFolder, 'Load & edit scene from file', start);
        const createNewButton = sceneSelectionFolder.addButton({
            title: 'Create new'
        }).on('click', e => start());


    </script>
</body>
</html>
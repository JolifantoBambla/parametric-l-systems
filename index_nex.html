<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parametric L-Systems</title>
    <!-- import materialize -->
    <link rel="stylesheet" href="css/materialize/css/materialize.min.css"/>

    <!-- import Google icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- import tweakpane for the viewer's UI elements -->
    <script src="js/external/tweakpane/tweakpane-3.1.1.min.js"></script>
    <script src="js/external/tweakpane-plugin-essentials/tweakpane-plugin-essentials-0.1.5.min.js"></script>
</head>
<body>
    <header>
        <div class="row">
            <div class="col xl12">
                <h1>Parametric L-System Explorer</h1>
            </div>
        </div>
    </header>
    <div class="divider"></div>

    <main>
        <div class="row">
            <div class="col xl12">
                <div class="col xl4">
                    <div class="row">
                        <h4>Scene Editor</h4>
                        <div class="col xl12">
                            <div id="editor" style="width: 100%; height: 50vh; border: 1px solid grey"> </div>
                            <div class = "file-field input-field waves-effect waves-light btn-small" style="width: 24.6%;" type="submit">
                                <i class="material-icons left">cloud_upload</i>Upload Scene
                                <input type="file" accept="application/json" id="scene-upload-button">
                            </div>
                            <button class="waves-effect waves-light btn-small" style="width: 24.6%;" type="submit" id="scene-download-button"><i class="material-icons left">save</i>Save Scene</button>
                            <button class="waves-effect waves-light btn-small" style="width: 24.5%;" type="submit" id="l-system-test-button"><i class="material-icons left">play_circle_outline</i>Test</button>
                            <button class="waves-effect waves-light btn-small" style="width: 24.6%;" type="submit" id="l-system-render-button"><i class="material-icons left">play_circle_filled</i>Render</button>
                        </div>
                    </div>
                    <div class="divider"></div>
                    <div class="row">
                        <div class="col xl12">
                            <h5>Iterations</h5>
                            <textarea id="l-system-iterations" style="height: 14vh;" readonly="readonly"></textarea>
                        </div>
                    </div>
                </div>

                <div class="col xl8" id="scene-view-container" style="position: relative; height: 80vh;">
                    <!--<h4>Viewer</h4>-->
                    <canvas style="width: 100%; height: 100%; background-color:rgb(0, 0, 0);position: absolute" id="scene-view"></canvas>
                    <div id="ui" style="position: absolute; right: 0; z-index: 1"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="page-footer">
        <div class="container">
            <div class="row">
                <div class="col l6 xl12">
                    <h5 class="white-text">Footer Content</h5>
                    <p class="grey-text text-lighten-4">You can use rows and columns here to organize your footer content.</p>
                </div>
            </div>
        </div>
        <div class="footer-copyright">
            <div class="container">
                Â© 2023 Copyright Text
                <a class="grey-text text-lighten-4 right" href="#!">More Links</a>
            </div>
        </div>
    </footer>

    <script type="text/javascript" src="js/external/materialize/js/materialize.min.js"></script>
    <script src="ace-builds-1.5.0/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script>
        // https://stackoverflow.com/questions/19721439/download-json-object-as-a-file-from-browser
        function downloadObjectAsJson(obj, fileName, indent = null){
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute(
                'href', `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(obj, null, indent))}`
            );
            downloadAnchorNode.setAttribute('download', `${fileName}.json`);
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>

    <script type="module">
        import init, { main } from "./pkg/parametric_l_systems.js";
        import {LSystemIterator} from './js/l-system/l-system.js';
        import * as defaultScene from './scenes/tree-prusinkiewicz.json' assert {type: 'json'};

        const sceneCanvas = document.getElementById('scene-view');
        console.log(sceneCanvas.id, sceneCanvas.width, sceneCanvas.height, sceneCanvas.innerWidth, sceneCanvas.innerHeight);

        const editor = ace.edit('editor');
        editor.setTheme('ace/theme/github');
        editor.session.setMode('ace/mode/json');
        editor.setValue(JSON.stringify({...defaultScene.default}, null, 2));

        const lSystemIterations = document.getElementById('l-system-iterations');

        const parseCurrentSceneSource = () => {
            // todo: parse DSL into scene JSON / object
            return JSON.parse(editor.getValue());
        }
        const parseSceneJsonToDSL = sceneJson => {
            // todo: parse scene into L-System DSL
            return sceneJson;
        }

        const testSystems = (scene) => {
            return Object.keys(scene.systems).map(systemName => {
                const s = scene.systems[systemName];
                console.log(systemName, s);
                const iterator = LSystemIterator.createLSystemIterator(s);
                const results = [
                    `System "${systemName}":`,
                    `\t0: ${iterator.current()}`
                ];
                for (let i = 0; i < 3; ++i) {
                    results.push(`\t${i + 1}: ${iterator.next()}`);
                }
                return results.join('\n');
            });
        };
        const testAndPrintSystems = (scene) => {
            lSystemIterations.value = testSystems(scene).join('\n\n');
        }

        // todo: start with default scene
        // todo: only initialize once
        // todo: new format
        // todo: ui
        async function run(canvasId, lSystem, settings) {
            await init();
            main(canvasId, settings, lSystem);
        }

        const constructViewerInputFromScene = (scene) => {
            // todo: multiple lSystems
            // todo: other objects

            const lSystemSceneObject = scene.scene.objects[0];
            const instance = scene.instances[lSystemSceneObject.instance];
            console.log(lSystemSceneObject, scene.systems[instance.system]);
            const lSystem = scene.systems[instance.system];
            lSystem.parameters = {
                ...lSystem.parameters,
                ...lSystemSceneObject.parameters
            }

            // todo: new format
            const sceneSettings = {
                lightSources: scene.scene.lights.pointLights.map(p => {
                    return {
                        light: {
                            color: p.color,
                            intensity: 1.0,
                        },
                        source: {
                            point: {
                                position: p.position,
                            }
                        }
                    }
                }),
                lSystemSettings: {
                    materials: [{color: [...instance.materials[0].color, 1.0]}]
                }
            };
            run(sceneCanvas.id, lSystem, sceneSettings);
        }

        const sceneUploadButton = document.getElementById('scene-upload-button');
        sceneUploadButton.addEventListener('change', e => {
            const reader = new FileReader();
            reader.onload = event => {
                const scene = parseSceneJsonToDSL(JSON.parse(String(event.target.result)));
                // todo: parse scene into L-System DSL
                editor.setValue(String(event.target.result));
            }
            reader.readAsText(e.target.files[0]);
        });
        const sceneDownloadButton = document.getElementById('scene-download-button');
        sceneDownloadButton.addEventListener('click', _ => {
            // todo: parse DSL to scene JSON / object
            downloadObjectAsJson(parseCurrentSceneSource(), 'scene', 2);
        });
        const lSystemTestButton = document.getElementById('l-system-test-button');
        lSystemTestButton.addEventListener('click', () => {
            const scene = parseCurrentSceneSource();
            if (scene.systems) {
                testAndPrintSystems(scene);
            }
        })
        const lSytemRenderbutton = document.getElementById('l-system-render-button');
        lSytemRenderbutton.addEventListener('click', _ => {
            const scene = parseCurrentSceneSource();
            if (scene.systems) {
                testAndPrintSystems(scene);
                constructViewerInputFromScene(scene);
            }
        });

        const uiElement = document.getElementById('ui');
        const sceneViewContainer = document.getElementById('scene-view-container');


        const pane = new Tweakpane.Pane({
            title: 'Parametric L-Systems',
            expanded: true,
            container: uiElement,
        });
        pane.registerPlugin(TweakpaneEssentialsPlugin);



    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parametric L-Systems</title>
    <!-- import tweakpane for creating & managing the UI elements -->
    <script src="js/external/tweakpane/tweakpane-3.1.1.min.js"></script>
    <script src="js/external/tweakpane-plugin-essentials/tweakpane-plugin-essentials-0.1.5.min.js"></script>
</head>
<body>
    <script type="module">
        import { addJsonFilePicker } from "./js/util/tweakpane-file-picker.js";

        const pane = new Tweakpane.Pane({
            title: 'Parametric L-Systems',
            expanded: true,
        });
        pane.registerPlugin(TweakpaneEssentialsPlugin);

        const sceneSelectionFolder = pane.addFolder({
            title: 'Scene',
            expanded: true,
        });
        const start = (scene) => {
            sceneSelectionFolder.hidden = true;
            const sceneDetails = {
                lSystem: {
                    alphabet: [],
                    axiom: '',
                    productions: [],
                    parameters: {},
                    maxIterations: 0,
                },
                lightSources: [],
                materials: [],
                ...scene,
            }

            const sceneFolder = pane.addTab({
                pages: [
                    {title: 'L-System'},
                    {title: 'Scene'}
                ]
            });

            const lSystemFolder = sceneFolder.pages[0];

            lSystemFolder.addInput(sceneDetails.lSystem, 'axiom');

            const addExpandableList = (folder, list, title, addNewText, addNewListener = null) => {
                const listFolder = lSystemFolder.addFolder({
                    title,
                    expanded: true,
                });
                for (const i in list) {
                    const inputElement = listFolder.addInput(list, i);
                    if (addNewListener) {
                        addNewListener({
                            key: i,
                            inputElement,
                        })
                    }
                }
                let addNewButton = listFolder.addButton({
                    title: addNewText
                });
                const addNewElement = e => {
                    addNewButton.hidden = true;
                    const i = `${list.length}`;
                    list.push('');
                    const inputElement = listFolder.addInput(list, i);
                    if (addNewListener) {
                        addNewListener({
                            key: i,
                            inputElement,
                        })
                    }
                    addNewButton = listFolder.addButton({
                        title: addNewText
                    });
                    addNewButton.on('click', addNewElement);

                };
                addNewButton.on('click', addNewElement);
            }

            addExpandableList(lSystemFolder, sceneDetails.lSystem.alphabet, 'Alphabet', 'Add new symbol');
            addExpandableList(lSystemFolder, sceneDetails.lSystem.productions, 'Productions', 'Add new production');

            const parametersFolder = lSystemFolder.addFolder({title: 'L-System Parameters', expanded: true});
            const parametersListFolder = parametersFolder.addFolder({title: 'Parameters', expanded: true});
            for (const i in sceneDetails.lSystem.parameters) {
                parametersListFolder.addInput(sceneDetails.lSystem.parameters, i);
            }

            const newParameterInput = {name: 'param', value: '0.0'};
            const newParametersFolder = parametersFolder.addFolder({title: 'New Parameter', expanded: false});
            newParametersFolder.addInput(newParameterInput, 'name');
            newParametersFolder.addInput(newParameterInput, 'value');
            newParametersFolder.addButton({title: 'Add new parameter'})
                .on('click', e => {
                    if (sceneDetails.lSystem.parameters[newParameterInput.name] !== undefined) {
                        alert(`L-System parameter '${newParameterInput.name}' already exists.`);
                    } else {
                        const value = Number(newParameterInput.value);
                        sceneDetails.lSystem.parameters[newParameterInput.name] = isNaN(value) ? newParameterInput.value : value;
                        parametersListFolder.addInput(sceneDetails.lSystem.parameters, newParameterInput.name);
                    }
                });

            // todo: update parameter list when new one is added / name is changed

            if (sceneDetails.lSystem.parameterPresets && sceneDetails.lSystem.parameterPresets.length) {
                const parameterPresetFolder = lSystemFolder.addFolder({title: 'Parameter preset', expanded: true});

                // todo: only add presets they exist
                // todo: update parameters based on preset
                parameterPresetFolder.addBlade({
                    view: 'list',
                    label: 'Choose preset',
                    options: sceneDetails.lSystem.parameterPresets.map((p, i) => {
                        return {
                            text: `Preset ${i}`,
                            value: `${i}`
                        };
                    }),
                    value: '0'
                });
            }

            // todo: add scene page
            // todo: add lights & materials
            // todo: add start button
            // todo: add export button (export sceneDetails)
        }
        const renderExistingScene = addJsonFilePicker(sceneSelectionFolder, 'Load & render scene from file', scene => console.log('todo: render scene', scene));
        const sceneFileUploadButton = addJsonFilePicker(sceneSelectionFolder, 'Load & edit scene from file', start);
        const createNewButton = sceneSelectionFolder.addButton({
            title: 'Create new'
        }).on('click', e => start());


    </script>
</body>
</html>